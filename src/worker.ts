// Declare global types imported by importScripts()
import type Web3Type from "web3";
import type { AbiItem } from "web3-utils";
import type { Contract } from "web3-eth-contract";
// @ts-expect-error solc doesn't have type definitions
import wrapper from "solc/wrapper";
import { Buffer } from "buffer";

declare const Ganache: any;
declare const Web3: typeof Web3Type;

interface SolidarityCompilation {
  errors?: { severity: "error" | "warning"; formattedMessage: string }[];
  contracts: {
    [source: string]: {
      [name: string]: {
        abi: AbiItem[] | AbiItem;
        evm: { bytecode: { object: string } };
      };
    };
  };
}

interface SolidarityContract {
  abi: AbiItem[] | AbiItem;
  bytecode: string;
}

type SolidarityContracts<Name extends string = string> = {
  [name in Name]: SolidarityContract;
};

// Import the Solidity compiler, Ethereum simulator and Web3 helper library
(self as any).window = self; // Required by web3.js
(self as any).Buffer = Buffer; // Required by ganache
importScripts(
  // "https://solc-bin.ethereum.org/bin/soljson-latest.js",
  "https://solc-bin.ethereum.org/bin/soljson-v0.8.11+commit.d7f03943.js",
  "https://cdn.jsdelivr.net/npm/ganache@7.0.0/dist/web/ganache.min.js",
  "https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"
);
const solc = wrapper((self as any).Module);


// Whether to run offline or online
const ENV_TYPE: string = "offline";
// Create new local Ethereum simulator
var provider: any;
if (ENV_TYPE == "offline") {
  provider = Ganache.provider({ gasLimit: 100000000 });
} else {
  provider = self.ethereum;
}

const web3 = new Web3(provider);

async function compileContracts<Name extends string = string>(
  code: string,
  imports?: Record<string, string>
): Promise<SolidarityContracts<Name>> {
  // Compile Solidity source code
  const source = "input.sol";
  const input = {
    language: "Solidity",
    sources: {
      [source]: { content: code },
    },
    settings: {
      outputSelection: { "*": { "*": ["*"] } },
    },
  };
  const output: SolidarityCompilation = JSON.parse(
    solc.compile(JSON.stringify(input), {
      import(path: string) {
        return imports?.[path]
          ? { contents: imports[path] }
          : { error: "File not found" };
      },
    })
  );
  output.errors = output.errors?.filter((error) => {
    if (error.severity === "warning") {
      console.warn(error.formattedMessage);
      return false;
    }
    return true;
  });
  if (output.errors?.length) {
    const messages = output.errors.map((error) => error.formattedMessage);
    throw new SyntaxError(`\n${messages.join("\n")}`);
  }

  // Extract compiled contracts
  const entries = Object.entries(output.contracts[source]).map<
    [string, SolidarityContract]
  >(([name, contract]) => [
    name,
    { abi: contract.abi, bytecode: contract.evm.bytecode.object },
  ]);
  return Object.fromEntries(entries) as SolidarityContracts<Name>;
}

async function deployContract(
  contract: SolidarityContract,
  account: string,
  args?: any[]
) {
  // Deploy contract to local Ethereum network
  console.log(contract.bytecode);
  console.log(web3.utils.isHex(contract.bytecode));
  return new web3.eth.Contract(contract.abi)
    .deploy({ data: contract.bytecode, arguments: args })
    .send({ from: account, gas: 10000000 });
}

async function deployGamesContract(
  contract: SolidarityContract,
  account: string,
  args?: any[]
) {
  // Deploy contract to local Ethereum network

  let bytecode = "608060405260006009553480156200001657600080fd5b506040518060400160405280600381526020017f4f524200000000000000000000000000000000000000000000000000000000008152506000908051906020019062000064929190620001f5565b506040518060400160405280600481526020017f4f7262730000000000000000000000000000000000000000000000000000000081525060019080519060200190620000b2929190620001f5565b5060028060006101000a81548160ff021916908360ff160217905550600060038190555033600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550604051620001259062000286565b604051809103906000f08015801562000142573d6000803e3d6000fd5b50600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550604051620001919062000294565b604051809103906000f080158015620001ae573d6000803e3d6000fd5b50600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555062000326565b8280546200020390620002f0565b90600052602060002090601f01602090048101928262000227576000855562000273565b82601f106200024257805160ff191683800117855562000273565b8280016001018555821562000273579182015b828111156200027257825182559160200191906001019062000255565b5b509050620002829190620002a2565b5090565b610ea78062002f3f83390190565b61101a8062003de683390190565b5b80821115620002bd576000816000905550600101620002a3565b5090565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200030957607f821691505b6020821081141562000320576200031f620002c1565b5b50919050565b612c0980620003366000396000f3fe608060405234801561001057600080fd5b50600436106101165760003560e01c806395d89b41116100a2578063bee74ba711610071578063bee74ba7146102f3578063c47a304214610323578063c5fae05814610341578063cae9ca511461035f578063dd62ed3e1461038f57610116565b806395d89b411461025957806399310c89146102775780639db94356146102a7578063a9059cbb146102c357610116565b8063313ce567116100e9578063313ce567146101b75780633aa9dd2a146101d557806340e58ee5146101f15780636a23626b1461020d57806370a082311461022957610116565b806306fdde031461011b578063095ea7b31461013957806318160ddd1461016957806323b872dd14610187575b600080fd5b6101236103bf565b6040516101309190611fb3565b60405180910390f35b610153600480360381019061014e919061207d565b61044d565b60405161016091906120d8565b60405180910390f35b61017161053f565b60405161017e9190612102565b60405180910390f35b6101a1600480360381019061019c919061211d565b610593565b6040516101ae91906120d8565b60405180910390f35b6101bf610979565b6040516101cc919061218c565b60405180910390f35b6101ef60048036038101906101ea91906121a7565b61098c565b005b61020b600480360381019061020691906121e7565b610cdd565b005b6102276004803603810190610222919061207d565b610e02565b005b610243600480360381019061023e9190612214565b610ffa565b6040516102509190612102565b60405180910390f35b610261611043565b60405161026e9190611fb3565b60405180910390f35b610291600480360381019061028c9190612266565b6110d1565b60405161029e9190612102565b60405180910390f35b6102c160048036038101906102bc919061207d565b61123e565b005b6102dd60048036038101906102d8919061207d565b611436565b6040516102ea91906120d8565b60405180910390f35b61030d600480360381019061030891906121e7565b6116a3565b60405161031a91906120d8565b60405180910390f35b61032b6118a2565b6040516103389190612318565b60405180910390f35b6103496118c8565b6040516103569190612354565b60405180910390f35b610379600480360381019061037491906124a4565b6118ee565b60405161038691906120d8565b60405180910390f35b6103a960048036038101906103a49190612513565b611a52565b6040516103b69190612102565b60405180910390f35b600180546103cc90612582565b80601f01602080910402602001604051908101604052809291908181526020018280546103f890612582565b80156104455780601f1061041a57610100808354040283529160200191610445565b820191906000526020600020905b81548152906001019060200180831161042857829003601f168201915b505050505081565b600081600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161052d9190612102565b60405180910390a36001905092915050565b6000600760008073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205460035461058e91906125e3565b905090565b6000600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63d96378269091846040518363ffffffff1660e01b815260040161060f929190612626565b602060405180830381865af415801561062c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106509190612664565b600760008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63d96378269091846040518363ffffffff1660e01b815260040161074a929190612626565b602060405180830381865af4158015610767573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061078b9190612664565b600860008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63f703601e9091846040518363ffffffff1660e01b8152600401610885929190612626565b602060405180830381865af41580156108a2573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108c69190612664565b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516109669190612102565b60405180910390a3600190509392505050565b600260009054906101000a900460ff1681565b61099582611ad9565b6109d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109cb906126dd565b60405180910390fd5b6000600a600084815260200190815260200160002090508060000160405180604001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff16815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610af7338260020154610e02565b806001015481600001805490501415610cd8576000610b1584611b6a565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811415610be8577f864527b647c75dcfac89486e3ad58645d74ef3a7d95f5a59c3a8d4042216588760405160405180910390a160005b8260010154811015610be257610bcf836000018281548110610b9357610b926126fd565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16846002015461123e565b8080610bda9061272c565b915050610b6e565b50610c8c565b6000826000018281548110610c0057610bff6126fd565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690507f194e4e31104fa228c7cf735a3cf1161636c864e72ad62c9bd7d6c78e5114c7cc8582604051610c65929190612784565b60405180910390a1610c8a8184600101548560020154610c8591906127ad565b61123e565b505b600a600085815260200190815260200160002060008082016000610cb09190611e91565b600182016000905560028201600090556003820160006101000a81549060ff02191690555050505b505050565b610ce681611ad9565b610d25576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d1c90612853565b60405180910390fd5b6000600a6000838152602001908152602001600020905060005b8160010154811015610db357610da0826000018281548110610d6457610d636126fd565b5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836002015461123e565b8080610dab9061272c565b915050610d3f565b50600a600083815260200190815260200160002060008082016000610dd89190611e91565b600182016000905560028201600090556003820160006101000a81549060ff021916905550505050565b3373ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610e92576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e89906128bf565b60405180910390fd5b600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63d96378269091836040518363ffffffff1660e01b8152600401610f0c929190612626565b602060405180830381865af4158015610f29573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610f4d9190612664565b600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610fee9190612102565b60405180910390a35050565b6000600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000805461105090612582565b80601f016020809104026020016040519081016040528092919081815260200182805461107c90612582565b80156110c95780601f1061109e576101008083540402835291602001916110c9565b820191906000526020600020905b8154815290600101906020018083116110ac57829003601f168201915b505050505081565b600080600a600060095481526020019081526020016000209050600060028111156110ff576110fe6128df565b5b836002811115611112576111116128df565b5b1415611153576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161114a9061295a565b60405180910390fd5b828160030160006101000a81548160ff0219169083600281111561117a576111796128df565b5b0217905550600085116111c2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111b9906129c6565b60405180910390fd5b8481600201819055506111d58484611e18565b611214576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161120b90612a32565b60405180910390fd5b838160010181905550600960008154809291906112309061272c565b919050559150509392505050565b3373ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146112ce576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016112c5906128bf565b60405180910390fd5b600760008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63f703601e9091836040518363ffffffff1660e01b8152600401611348929190612626565b602060405180830381865af4158015611365573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906113899190612664565b600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161142a9190612102565b60405180910390a35050565b6000600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63d96378269091846040518363ffffffff1660e01b81526004016114b2929190612626565b602060405180830381865af41580156114cf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906114f39190612664565b600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600760008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63f703601e9091846040518363ffffffff1660e01b81526004016115b0929190612626565b602060405180830381865af41580156115cd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906115f19190612664565b600760008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516116919190612102565b60405180910390a36001905092915050565b60008082116116b157600080fd5b60035473__$145f435872e330c994331688f61982a327$__63f703601e9091846040518363ffffffff1660e01b81526004016116ee929190612626565b602060405180830381865af415801561170b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061172f9190612664565b600381905550600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205473__$145f435872e330c994331688f61982a327$__63f703601e9091846040518363ffffffff1660e01b81526004016117af929190612626565b602060405180830381865af41580156117cc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906117f09190612664565b600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055503373ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516118919190612102565b60405180910390a360019050919050565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600082600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925856040516119ce9190612102565b60405180910390a38373ffffffffffffffffffffffffffffffffffffffff16635586eaa6338530866040518563ffffffff1660e01b8152600401611a159493929190612aa7565b600060405180830381600087803b158015611a2f57600080fd5b505af1158015611a43573d6000803e3d6000fd5b50505050600190509392505050565b6000600860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600080600a6000848152602001908152602001600020905060008160020154118015611b3b575060006002811115611b1457611b136128df565b5b8160030160009054906101000a900460ff166002811115611b3857611b376128df565b5b14155b8015611b625750611b6181600101548260030160009054906101000a900460ff16611e18565b5b915050919050565b600080600a600084815260200190815260200160002090506000816001015467ffffffffffffffff811115611ba257611ba1612379565b5b604051908082528060200260200182016040528015611bd05781602001602082028036833780820191505090505b50905060005b8260010154811015611c8a57826000018181548110611bf857611bf76126fd565b5b906000526020600020906002020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16828281518110611c3d57611c3c6126fd565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508080611c829061272c565b915050611bd6565b5060016002811115611c9f57611c9e6128df565b5b8260030160009054906101000a900460ff166002811115611cc357611cc26128df565b5b1415611d7057600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16636216603f826040518263ffffffff1660e01b8152600401611d249190612bb1565b6020604051808303816000875af1158015611d43573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611d679190612664565b92505050611e13565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16636216603f826040518263ffffffff1660e01b8152600401611dcb9190612bb1565b6020604051808303816000875af1158015611dea573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611e0e9190612664565b925050505b919050565b6000806002811115611e2d57611e2c6128df565b5b826002811115611e4057611e3f6128df565b5b1415611e4b57600080fd5b60016002811115611e5f57611e5e6128df565b5b826002811115611e7257611e716128df565b5b1415611e8357600283149050611e8b565b600283101590505b92915050565b5080546000825560020290600052602060002090810190611eb29190611eb5565b50565b5b80821115611f1657600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600201611eb6565b5090565b600081519050919050565b600082825260208201905092915050565b60005b83811015611f54578082015181840152602081019050611f39565b83811115611f63576000848401525b50505050565b6000601f19601f8301169050919050565b6000611f8582611f1a565b611f8f8185611f25565b9350611f9f818560208601611f36565b611fa881611f69565b840191505092915050565b60006020820190508181036000830152611fcd8184611f7a565b905092915050565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061201482611fe9565b9050919050565b61202481612009565b811461202f57600080fd5b50565b6000813590506120418161201b565b92915050565b6000819050919050565b61205a81612047565b811461206557600080fd5b50565b60008135905061207781612051565b92915050565b6000806040838503121561209457612093611fdf565b5b60006120a285828601612032565b92505060206120b385828601612068565b9150509250929050565b60008115159050919050565b6120d2816120bd565b82525050565b60006020820190506120ed60008301846120c9565b92915050565b6120fc81612047565b82525050565b600060208201905061211760008301846120f3565b92915050565b60008060006060848603121561213657612135611fdf565b5b600061214486828701612032565b935050602061215586828701612032565b925050604061216686828701612068565b9150509250925092565b600060ff82169050919050565b61218681612170565b82525050565b60006020820190506121a1600083018461217d565b92915050565b600080604083850312156121be576121bd611fdf565b5b60006121cc85828601612068565b92505060206121dd85828601612032565b9150509250929050565b6000602082840312156121fd576121fc611fdf565b5b600061220b84828501612068565b91505092915050565b60006020828403121561222a57612229611fdf565b5b600061223884828501612032565b91505092915050565b6003811061224e57600080fd5b50565b60008135905061226081612241565b92915050565b60008060006060848603121561227f5761227e611fdf565b5b600061228d86828701612068565b935050602061229e86828701612068565b92505060406122af86828701612251565b9150509250925092565b6000819050919050565b60006122de6122d96122d484611fe9565b6122b9565b611fe9565b9050919050565b60006122f0826122c3565b9050919050565b6000612302826122e5565b9050919050565b612312816122f7565b82525050565b600060208201905061232d6000830184612309565b92915050565b600061233e826122e5565b9050919050565b61234e81612333565b82525050565b60006020820190506123696000830184612345565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6123b182611f69565b810181811067ffffffffffffffff821117156123d0576123cf612379565b5b80604052505050565b60006123e3611fd5565b90506123ef82826123a8565b919050565b600067ffffffffffffffff82111561240f5761240e612379565b5b61241882611f69565b9050602081019050919050565b82818337600083830152505050565b6000612447612442846123f4565b6123d9565b90508281526020810184848401111561246357612462612374565b5b61246e848285612425565b509392505050565b600082601f83011261248b5761248a61236f565b5b813561249b848260208601612434565b91505092915050565b6000806000606084860312156124bd576124bc611fdf565b5b60006124cb86828701612032565b93505060206124dc86828701612068565b925050604084013567ffffffffffffffff8111156124fd576124fc611fe4565b5b61250986828701612476565b9150509250925092565b6000806040838503121561252a57612529611fdf565b5b600061253885828601612032565b925050602061254985828601612032565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061259a57607f821691505b602082108114156125ae576125ad612553565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006125ee82612047565b91506125f983612047565b92508282101561260c5761260b6125b4565b5b828203905092915050565b61262081612047565b82525050565b600060408201905061263b6000830185612617565b6126486020830184612617565b9392505050565b60008151905061265e81612051565b92915050565b60006020828403121561267a57612679611fdf565b5b60006126888482850161264f565b91505092915050565b7f43616e6e6f74206a6f696e20696e76616c69642067616d652100000000000000600082015250565b60006126c7601983611f25565b91506126d282612691565b602082019050919050565b600060208201905081810360008301526126f6816126ba565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061273782612047565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82141561276a576127696125b4565b5b600182019050919050565b61277e81612009565b82525050565b600060408201905061279960008301856120f3565b6127a66020830184612775565b9392505050565b60006127b882612047565b91506127c383612047565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff04831182151516156127fc576127fb6125b4565b5b828202905092915050565b7f43616e6e6f742063616e63656c20696e76616c69642067616d65210000000000600082015250565b600061283d601b83611f25565b915061284882612807565b602082019050919050565b6000602082019050818103600083015261286c81612830565b9050919050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572600082015250565b60006128a9602083611f25565b91506128b482612873565b602082019050919050565b600060208201905081810360008301526128d88161289c565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b7f47616d6520747970652063616e6e6f74206265204e756c6c2e00000000000000600082015250565b6000612944601983611f25565b915061294f8261290e565b602082019050919050565b6000602082019050818103600083015261297381612937565b9050919050565b7f5374616b65206d7573742062652067726561746572207468616e207a65726f2e600082015250565b60006129b0602083611f25565b91506129bb8261297a565b602082019050919050565b600060208201905081810360008301526129df816129a3565b9050919050565b7f53697a65206f662067616d6520697320696e76616c69642e0000000000000000600082015250565b6000612a1c601883611f25565b9150612a27826129e6565b602082019050919050565b60006020820190508181036000830152612a4b81612a0f565b9050919050565b600081519050919050565b600082825260208201905092915050565b6000612a7982612a52565b612a838185612a5d565b9350612a93818560208601611f36565b612a9c81611f69565b840191505092915050565b6000608082019050612abc6000830187612775565b612ac960208301866120f3565b612ad66040830185612775565b8181036060830152612ae88184612a6e565b905095945050505050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b612b2881612009565b82525050565b6000612b3a8383612b1f565b60208301905092915050565b6000602082019050919050565b6000612b5e82612af3565b612b688185612afe565b9350612b7383612b0f565b8060005b83811015612ba4578151612b8b8882612b2e565b9750612b9683612b46565b925050600181019050612b77565b5085935050505092915050565b60006020820190508181036000830152612bcb8184612b53565b90509291505056fea26469706673582212206395fdb2c3665ba058e78b7ba40cd7756dfb8406840263ac6613240f6574ddea64736f6c634300080b00336080604052604051806101a00160405280600b60ff168152602001600260ff168152602001600360ff168152602001600460ff168152602001600560ff168152602001600660ff168152602001600760ff168152602001600860ff168152602001600960ff168152602001600a60ff168152602001600a60ff168152602001600a60ff168152602001600a60ff16815250600090600d6100a09291906100b8565b506001600d553480156100b257600080fd5b5061011a565b82600d81019282156100ec579160200282015b828111156100eb578251829060ff169055916020019190600101906100cb565b5b5090506100f991906100fd565b5090565b5b808211156101165760008160009055506001016100fe565b5090565b610d7e806101296000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c80636216603f14610030575b600080fd5b61004a600480360381019061004591906109c4565b610060565b6040516100579190610a26565b60405180910390f35b6000806040518060400160405280603467ffffffffffffffff81111561008957610088610823565b5b6040519080825280602002602001820160405280156100b75781602001602082028036833780820191505090505b5081526020016000815250905060005b60048110156101535760005b600d81101561013f57600081600d81106100f0576100ef610a41565b5b0154836000015182600d856101059190610a9f565b61010f9190610af9565b815181106101205761011f610a41565b5b602002602001018181525050808061013790610b4f565b9150506100d3565b50808061014b90610b4f565b9150506100c7565b5060005b603281101561021c576000610170600d5483603461067a565b600d60008294508391905055505060008360000151838151811061019757610196610a41565b5b60200260200101519050836000015182815181106101b8576101b7610a41565b5b6020026020010151846000015184815181106101d7576101d6610a41565b5b60200260200101818152505080846000015183815181106101fb576101fa610a41565b5b6020026020010181815250505050808061021490610b4f565b915050610157565b506000835190506000845167ffffffffffffffff8111156102405761023f610823565b5b60405190808252806020026020018201604052801561027957816020015b6102666107dd565b81526020019060019003908161025e5790505b50905060005b85518110156102d957604051806040016040528061029c866106d7565b8152602001600115158152508282815181106102bb576102ba610a41565b5b602002602001018190525080806102d190610b4f565b91505061027f565b5060005b855181101561037f578581815181106102f9576102f8610a41565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff167fabbc0dab802d57e5bb6026143d1978c9e4c69725cd3d860095cfddcbb4732f8283838151811061034b5761034a610a41565b5b6020026020010151600001516040516103649190610a26565b60405180910390a2808061037790610b4f565b9150506102dd565b505b60008211156105a35760005b855181101561059d578181815181106103a9576103a8610a41565b5b6020026020010151602001511561058a5760006103fe8783815181106103d2576103d1610a41565b5b60200260200101518484815181106103ed576103ec610a41565b5b602002602001015160000151610707565b905060028081111561041357610412610b98565b5b81600281111561042657610425610b98565b5b1415610459577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95505050505050610675565b86828151811061046c5761046b610a41565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff167f5996ade9b221ff04cc2f38a4c7feeaafab7a2e7753f7773cf744bb1edde962fc8484815181106104be576104bd610a41565b5b602002602001015160000151836040516104d9929190610c0f565b60405180910390a2600060028111156104f5576104f4610b98565b5b81600281111561050857610507610b98565b5b141561054e5761051785610796565b83838151811061052a57610529610a41565b5b60200260200101516000018181516105429190610af9565b91508181525050610588565b600083838151811061056357610562610a41565b5b60200260200101516020019015159081151581525050838061058490610c38565b9450505b505b808061059590610b4f565b91505061038d565b50610381565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff905060005b865181101561066c5760158382815181106105e9576105e8610a41565b5b6020026020010151600001511415610659577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82141561062b57809150610658565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff95505050505050610675565b5b808061066490610b4f565b9150506105cb565b50809450505050505b919050565b60008060006141a790506000637fffffff905080878361069a9190610a9f565b6106a49190610c91565b96508686866106b39190610cc2565b886106be9190610c91565b876106c99190610af9565b935093505050935093915050565b6000806106e383610796565b905060006106f084610796565b905080826106fe9190610af9565b92505050919050565b60008273ffffffffffffffffffffffffffffffffffffffff1663e29849da836040518263ffffffff1660e01b81526004016107429190610a26565b6020604051808303816000875af192505050801561077e57506040513d601f19601f8201168201806040525081019061077b9190610d1b565b60015b61078b5760029050610790565b809150505b92915050565b60008082600001518360200151815181106107b4576107b3610a41565b5b602002602001015190508260200180518091906107d090610b4f565b8152505080915050919050565b6040518060400160405280600081526020016000151581525090565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61085b82610812565b810181811067ffffffffffffffff8211171561087a57610879610823565b5b80604052505050565b600061088d6107f9565b90506108998282610852565b919050565b600067ffffffffffffffff8211156108b9576108b8610823565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006108fa826108cf565b9050919050565b61090a816108ef565b811461091557600080fd5b50565b60008135905061092781610901565b92915050565b600061094061093b8461089e565b610883565b90508083825260208201905060208402830185811115610963576109626108ca565b5b835b8181101561098c57806109788882610918565b845260208401935050602081019050610965565b5050509392505050565b600082601f8301126109ab576109aa61080d565b5b81356109bb84826020860161092d565b91505092915050565b6000602082840312156109da576109d9610803565b5b600082013567ffffffffffffffff8111156109f8576109f7610808565b5b610a0484828501610996565b91505092915050565b6000819050919050565b610a2081610a0d565b82525050565b6000602082019050610a3b6000830184610a17565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610aaa82610a0d565b9150610ab583610a0d565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615610aee57610aed610a70565b5b828202905092915050565b6000610b0482610a0d565b9150610b0f83610a0d565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610b4457610b43610a70565b5b828201905092915050565b6000610b5a82610a0d565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610b8d57610b8c610a70565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b60038110610bd857610bd7610b98565b5b50565b6000819050610be982610bc7565b919050565b6000610bf982610bdb565b9050919050565b610c0981610bee565b82525050565b6000604082019050610c246000830185610a17565b610c316020830184610c00565b9392505050565b6000610c4382610a0d565b91506000821415610c5757610c56610a70565b5b600182039050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610c9c82610a0d565b9150610ca783610a0d565b925082610cb757610cb6610c62565b5b828206905092915050565b6000610ccd82610a0d565b9150610cd883610a0d565b925082821015610ceb57610cea610a70565b5b828203905092915050565b60038110610d0357600080fd5b50565b600081519050610d1581610cf6565b92915050565b600060208284031215610d3157610d30610803565b5b6000610d3f84828501610d06565b9150509291505056fea26469706673582212200fe9ace1232bb30de2425430bfae52d7582ee6fffb8b19d535ac1b40d493fdf664736f6c634300080b0033608060405234801561001057600080fd5b50610ffa806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c80636216603f14610030575b600080fd5b61004a60048036038101906100459190610b60565b610060565b6040516100579190610bc2565b60405180910390f35b600060028251146100a6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161009d90610c3a565b60405180910390fd5b6000826000815181106100bc576100bb610c5a565b5b602002602001015190506000836001815181106100dc576100db610c5a565b5b602002602001015190506000600190506000600967ffffffffffffffff811115610109576101086109bf565b5b6040519080825280602002602001820160405280156101375781602001602082028036833780820191505090505b50905060005b6000600281111561015157610150610c89565b5b81600281111561016457610163610c89565b5b14801561017757506101758261032b565b155b15610316576000610187846103ab565b905060006101c8600160028111156101a2576101a1610c89565b5b8360028111156101b5576101b4610c89565b5b146101c057866101c2565b875b856103d5565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114156101fd57600092505050610316565b6102078482610483565b610246576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023d90610d04565b60405180910390fd5b8184828151811061025a57610259610c5a565b5b6020026020010190600281111561027457610273610c89565b5b9081600281111561028857610287610c89565b5b815250507f638e7ac94faa172073bfcbfb321a0a056fdf102a598629173424cd4c5fdbfe69846040516102bb9190610e1b565b60405180910390a160006102ce856104e8565b9050600060028111156102e4576102e3610c89565b5b8160028111156102f7576102f6610c89565b5b14610300578093505b858061030b90610e6c565b96505050505061013d565b61031f816108ff565b95505050505050919050565b600080600090505b60098110156103a057600060028111156103505761034f610c89565b5b83828151811061036357610362610c5a565b5b6020026020010151600281111561037d5761037c610c89565b5b141561038d5760009150506103a6565b808061039890610e6c565b915050610333565b50600190505b919050565b600060016002836103bc9190610ee4565b14156103cb57600190506103d0565b600290505b919050565b60008273ffffffffffffffffffffffffffffffffffffffff1663709fb514836040518263ffffffff1660e01b81526004016104109190610e1b565b6020604051808303816000875af192505050801561044c57506040513d601f19601f820116820180604052508101906104499190610f41565b60015b610478577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff905061047d565b809150505b92915050565b6000808210158015610496575060088211155b80156104e05750600060028111156104b1576104b0610c89565b5b8383815181106104c4576104c3610c5a565b5b602002602001015160028111156104de576104dd610c89565b5b145b905092915050565b600080600090505b600381101561072057826001826105079190610f6e565b8151811061051857610517610c5a565b5b6020026020010151600281111561053257610531610c89565b5b83828151811061054557610544610c5a565b5b6020026020010151600281111561055f5761055e610c89565b5b1480156105db5750826002826105759190610f6e565b8151811061058657610585610c5a565b5b602002602001015160028111156105a05761059f610c89565b5b836001836105ae9190610f6e565b815181106105bf576105be610c5a565b5b602002602001015160028111156105d9576105d8610c89565b5b145b15610603578281815181106105f3576105f2610c5a565b5b60200260200101519150506108fa565b826003826106119190610f6e565b8151811061062257610621610c5a565b5b6020026020010151600281111561063c5761063b610c89565b5b83828151811061064f5761064e610c5a565b5b6020026020010151600281111561066957610668610c89565b5b1480156106e557508260068261067f9190610f6e565b815181106106905761068f610c5a565b5b602002602001015160028111156106aa576106a9610c89565b5b836003836106b89190610f6e565b815181106106c9576106c8610c5a565b5b602002602001015160028111156106e3576106e2610c89565b5b145b1561070d578281815181106106fd576106fc610c5a565b5b60200260200101519150506108fa565b808061071890610e6c565b9150506104f0565b508160048151811061073557610734610c5a565b5b6020026020010151600281111561074f5761074e610c89565b5b8260008151811061076357610762610c5a565b5b6020026020010151600281111561077d5761077c610c89565b5b1480156107e357508160088151811061079957610798610c5a565b5b602002602001015160028111156107b3576107b2610c89565b5b826004815181106107c7576107c6610c5a565b5b602002602001015160028111156107e1576107e0610c89565b5b145b1561080b57816000815181106107fc576107fb610c5a565b5b602002602001015190506108fa565b8160048151811061081f5761081e610c5a565b5b6020026020010151600281111561083957610838610c89565b5b8260028151811061084d5761084c610c5a565b5b6020026020010151600281111561086757610866610c89565b5b1480156108cd57508160068151811061088357610882610c5a565b5b6020026020010151600281111561089d5761089c610c89565b5b826004815181106108b1576108b0610c5a565b5b602002602001015160028111156108cb576108ca610c89565b5b145b156108f557816002815181106108e6576108e5610c5a565b5b602002602001015190506108fa565b600090505b919050565b600080600281111561091457610913610c89565b5b82600281111561092757610926610c89565b5b1415610955577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9050610990565b6001600281111561096957610968610c89565b5b82600281111561097c5761097b610c89565b5b141561098b5760009050610990565b600190505b919050565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6109f7826109ae565b810181811067ffffffffffffffff82111715610a1657610a156109bf565b5b80604052505050565b6000610a29610995565b9050610a3582826109ee565b919050565b600067ffffffffffffffff821115610a5557610a546109bf565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610a9682610a6b565b9050919050565b610aa681610a8b565b8114610ab157600080fd5b50565b600081359050610ac381610a9d565b92915050565b6000610adc610ad784610a3a565b610a1f565b90508083825260208201905060208402830185811115610aff57610afe610a66565b5b835b81811015610b285780610b148882610ab4565b845260208401935050602081019050610b01565b5050509392505050565b600082601f830112610b4757610b466109a9565b5b8135610b57848260208601610ac9565b91505092915050565b600060208284031215610b7657610b7561099f565b5b600082013567ffffffffffffffff811115610b9457610b936109a4565b5b610ba084828501610b32565b91505092915050565b6000819050919050565b610bbc81610ba9565b82525050565b6000602082019050610bd76000830184610bb3565b92915050565b600082825260208201905092915050565b7f496e76616c696420706c61796572730000000000000000000000000000000000600082015250565b6000610c24600f83610bdd565b9150610c2f82610bee565b602082019050919050565b60006020820190508181036000830152610c5381610c17565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b7f496e76616c6964206d6f76652100000000000000000000000000000000000000600082015250565b6000610cee600d83610bdd565b9150610cf982610cb8565b602082019050919050565b60006020820190508181036000830152610d1d81610ce1565b9050919050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60038110610d6157610d60610c89565b5b50565b6000819050610d7282610d50565b919050565b6000610d8282610d64565b9050919050565b610d9281610d77565b82525050565b6000610da48383610d89565b60208301905092915050565b6000602082019050919050565b6000610dc882610d24565b610dd28185610d2f565b9350610ddd83610d40565b8060005b83811015610e0e578151610df58882610d98565b9750610e0083610db0565b925050600181019050610de1565b5085935050505092915050565b60006020820190508181036000830152610e358184610dbd565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610e7782610ba9565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610eaa57610ea9610e3d565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610eef82610ba9565b9150610efa83610ba9565b925082610f0a57610f09610eb5565b5b828206905092915050565b610f1e81610ba9565b8114610f2957600080fd5b50565b600081519050610f3b81610f15565b92915050565b600060208284031215610f5757610f5661099f565b5b6000610f6584828501610f2c565b91505092915050565b6000610f7982610ba9565b9150610f8483610ba9565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610fb957610fb8610e3d565b5b82820190509291505056fea264697066735822122088c003bcc4f49cfec483d7c2b56a7a5f5ed248470ad3e33b59af6391c7dd006764736f6c634300080b0033"
  console.log(web3.utils.isHex(bytecode));
  return new web3.eth.Contract(contract.abi)
    .deploy({ data: bytecode, arguments: args })
    .send({ from: account, gas: 10000000 });
}
 // Add subscriptions
web3.eth.subscribe("pendingTransactions", (err, txnHash) => {
  if (err) console.error(err);
  else postMessage({ type: "pendingTransaction", txnHash });
});
web3.eth.subscribe("newBlockHeaders", (err, blockHeader) => {
  if (err) console.error(err);
  else postMessage({ type: "blockHeader", blockHeader });
});
// web3.eth.subscribe("logs", {}, (err, log) => {
//   if (err) console.error(err);
//   // const decoded = web3.eth.abi.decodeLog(
//   //   logContract.options.jsonInterface[0].inputs!,
//   //   log.data,
//   //   log.topics.slice(1)
//   // );
//   else postMessage({ type: "log", log });
// });

// Import Solidity contracts
// import gamesCode from "./eth/game/games.sol";
import orbCode from "./eth/game/orb.sol";
// import safeMathCode from "./eth/game/safe_math.sol";
import gameCode from "./eth/game/game.sol";
import ticTacToeCode from "./eth/game/tic_tac_toe.sol";
import blackjackCode from "./eth/game/blackjack.sol";
import { Account } from "web3-core";

// Compile and deploy shared Solidity contracts to local Ethereum network
const imports = {
  // "games.sol": gamesCode,
  "orb.sol": orbCode,
  // "safe_math.sol": safeMathCode,
  "game.sol": gameCode,
  "tic_tac_toe.sol": ticTacToeCode,
  "blackjack.sol": blackjackCode,
};

let accounts: string[];

let ticTacToeContract: Contract;
let ticTacToeBasicStrategyContract: Contract;

let blackjackContract: Contract;
let blackjackBasicStrategyContract: Contract;

let gamesContract: Contract;
let orbContract: Contract;
let tictactoeStrategy3: Contract;

let botAccount : string;
let playerAccount: string;

const initPromise = (async () => {
  if (ENV_TYPE == "offline") {

    const { Orb } = await compileContracts<
      "Orb"
      >(orbCode, imports);

    accounts = await web3.eth.getAccounts();
    let deployAccount: string = accounts[0];
    playerAccount = accounts[0];
    botAccount = accounts[1];

    // gamesContract = await deployContract(Games, deployAccount);
    gamesContract = await deployContract(Orb, deployAccount);

    gamesContract.methods.giveMeOrbs(10000).call({ from: playerAccount });
    gamesContract.methods.giveMeOrbs(10000).call({ from: botAccount });

    // let orbAddress = await gamesContract.methods.getOrbAddress().call();
    // console.log(orbContract);

    // old code
    const { Tic_tac_toe, Strategy_3 } = await compileContracts<
      "Tic_tac_toe" | "Strategy_3"
    >(ticTacToeCode, imports);
    const { Blackjack, Strategy_2 } = await compileContracts<
      "Blackjack" | "Strategy_1" | "Strategy_2"
    >(blackjackCode, imports);

    accounts = await web3.eth.getAccounts();

    // ticTacToeContract = await deployContract(Tic_tac_toe, accounts[0]);
    ticTacToeBasicStrategyContract = await deployContract(
      Strategy_3,
      accounts[1]
    );

    tictactoeStrategy3 = ticTacToeBasicStrategyContract;

    // blackjackContract = await deployContract(Blackjack, accounts[0]);
    blackjackBasicStrategyContract = await deployContract(
      Strategy_2,
      accounts[1]
    );
  } else {
    // online

    const { Orb } = await compileContracts<
      "Orb"
      >(orbCode, imports);

    const { Tic_tac_toe, Strategy_3 } = await compileContracts<
      "Tic_tac_toe" | "Strategy_3"
    >(ticTacToeCode, imports);

    tictactoeStrategy3 = new web3.eth.Contract(Strategy_3.abi, "0xDA35450A9ada64a324BFAD0A1f0F54d48398057F")
    // gamesContract = new web3.eth.Contract(Orb.abi, "0x8097F2723509D803aF03ba6CeeC49c71C05Cb820"); // TODO
    // orbContract = new web3.eth.Contract(Orb.abi, "0x4Af85eBE7F8dd30E6AbE585d459894B564e00cd8");
    botAccount = web3.eth.accounts.privateKeyToAccount("ec001c8d5f5f42031a8ccd6e932bf3ac6fad6d4006e8ebf768b1eb4e65c0c953").address
    
    var users = await web3.eth.getAccounts();
    playerAccount = users[0];
  }
})();


type Payload =
  | {
      type: "compile";
      code: string;
    }
  | {
      type: "simulate";
      code: string;
      game: "tic_tac_toe" | "blackjack";
    }
  | {
    type: "playGame";
    code: string;
    game: "tic_tac_toe" | "blackjack";
  };

addEventListener("message", async (event: MessageEvent<Payload>) => {
  if (event.data.type === "compile") {
    const contracts = await compileContracts(event.data.code);
    postMessage({ type: "compileResult", contracts });

  } else if (event.data.type === "simulate") {
    // Wait for contracts to be deployed
    await initPromise;

    // Get game and basic strategy contract instances
    const ticTacToe = event.data.game === "tic_tac_toe";
    const gameContract = ticTacToe ? ticTacToeContract : blackjackContract;
    const basicStrategyContract = ticTacToe
      ? ticTacToeBasicStrategyContract
      : blackjackBasicStrategyContract;

    // Compile and deploy user strategy to local Ethereum network
    const { CustomStrategy } = await compileContracts<"CustomStrategy">(
      event.data.code,
      imports
    );
    const customStrategyContract = await deployContract(
      CustomStrategy,
      accounts[2]
    );

    // Play game using user's strategy
    const txn = await gameContract.methods
      .play([
        basicStrategyContract.options.address,
        customStrategyContract.options.address,
      ])
      .send({ from: accounts[0], gas: 10000000 });

    // Extract game states from each turn
    const events: string[][] = txn.events["State_event"].map(
      (event: any) => event.returnValues
    );
    if (txn.events["Action_event"]) {
      events.push(
        ...txn.events["Action_event"].map((event: any) => event.returnValues)
      );
    }

    postMessage({ type: "simulateResult", result: events });
  
  } else if (event.data.type === "playGame") {
    // Wait for contracts to be deployed
    await initPromise;

    console.log("playGame");

    // Get game and basic strategy contract instances
    const ticTacToe = event.data.game === "tic_tac_toe";
    const gameContract = ticTacToe ? ticTacToeContract : blackjackContract;
    const basicStrategyContract = ticTacToe
      ? ticTacToeBasicStrategyContract
      : blackjackBasicStrategyContract;

      console.log("custom compile");
    
    // Compile and deploy user strategy to local Ethereum network
    const { CustomStrategy } = await compileContracts<"CustomStrategy">(
      event.data.code,
      imports
    );

    console.log("custom deploy");
    console.log(playerAccount);

    const customStrategyContract = await deployContract(
      CustomStrategy,
      playerAccount
    );

    console.log('txncreate');

    // Start a game
    let gameType = event.data.game == "blackjack" ? 2 : 1;
    const txnCreate = await gamesContract.methods.create(0, 2, gameType).send({ from: botAccount, gas: 10000000 });
    console.log(txnCreate);
    console.log('txnjoin1');
    const txnJoin1 = await gamesContract.methods.join(0, basicStrategyContract._address).send({ from: botAccount, gas: 10000000 }); // todo
    console.log(txnJoin1);
    console.log('txnjoin2');
    const txnJoin2 = await gamesContract.methods.join(0, customStrategyContract._address).send({ from: playerAccount, gas: 100000000})
    console.log(txnJoin2);
  }
});
